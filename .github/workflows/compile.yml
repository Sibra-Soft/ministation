name: Compile Visual Basic 6 Project

on:
  release:
    types: [published]
  
jobs:
  deploy:
    runs-on: windows-latest
    steps:
      - name: Download VB Compiler Image
        run: |
          Invoke-WebRequest "${{ secrets.COMPILER_IMAGE_URL }}" -OutFile vb_compiler_image.zip
         
      - name: Unzip Image
        run: |
          Expand-Archive -Path "vb_compiler_image.zip" -DestinationPath "vb_compiler_image"
          
      - name: Install + Verify Runtime
        run: |
          $process = Start-Process -FilePath ".\vb_compiler_image\runtime_setup.exe" -ArgumentList "/silent" -Wait -PassThru        
          $exitCode = $process.ExitCode
          if ($exitCode -eq 0 -or $exitCode -eq 3010)
          {
              Write-Host "Installation successful"
          }
          else
          {
              Write-Host "Non zero exit code returned by the installation process: $exitCode"
              exit $exitCode
          }
          
      - name: Install + Verify Compiler
        run: |
          $process = Start-Process -FilePath ".\vb_compiler_image\compiler_setup.exe" -ArgumentList "-S" -Wait -PassThru        
          $exitCode = $process.ExitCode
          if ($exitCode -eq 0 -or $exitCode -eq 3010)
          {
              Write-Host "Installation successful"
          }
          else
          {
              Write-Host "Non zero exit code returned by the installation process: $exitCode"
              exit $exitCode
          }

      - name: Checkout Visual Basic Project
        run: |
          Invoke-WebRequest "https://www.audiostation.org/downloads/project.zip" -OutFile project.zip
          
      - name: Unzip Project
        run: |
          Expand-Archive -Path "project.zip" -DestinationPath "./project/"
               
      - name: Register Project Dependencies
        shell: cmd
        run: | 
          cd ./project/deps
          CALL reg_deps.bat ../source/ministation.vbp
          
      - name: Prepare
        shell: cmd
        run: | 
          CALL ./project/prepare.bat
          
      - name: Run VBUnit (Unit Testing Framework)
        shell: cmd
        run: |
          exit 0
          
      - name: Compile Visual Basic Project
        shell: cmd
        run: |         
          CALL ./project/build.bat
          
      - name: Upload zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: compiled-project
          path: compile.zip
